<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Mapa - Patatag</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        .bg-brand-orange { background-color: #F97316; }
        #map { min-height: 500px; z-index: 1; cursor: crosshair; }
        .alert-toast { animation: slideIn 0.5s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    </style>
</head>
<body class="bg-gray-100">

    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-white shadow-lg flex flex-col fixed h-full z-20">
  <div class="p-6 text-center">
                <img src="https://i.imgur.com/Nwtd8hc.png" alt="Logo Patatag" class="h-16 mx-auto">
            </div>            <nav class="flex-grow p-4 space-y-2">
                <a href="/dashboard" class="flex items-center space-x-3 px-4 py-3 text-gray-600 hover:bg-gray-100 rounded-lg"><span>ğŸ¶ Meus Pets</span></a>
                <a href="/mapa" class="flex items-center space-x-3 px-4 py-3 bg-orange-100 text-[#F97316] font-bold rounded-lg"><span>ğŸ—ºï¸ Mapa Geral</span></a>
                <a href="/adicionar-pet" class="flex items-center space-x-3 px-4 py-3 text-gray-600 hover:bg-gray-100 rounded-lg"><span>â• Adicionar Pet</span></a>
                <a href="/perfil" class="flex items-center space-x-3 px-4 py-3 text-gray-600 hover:bg-gray-100 rounded-lg"><span>ğŸ‘¤ Meu Perfil</span></a>
            </nav>
            <div class="p-4">
                 <button onclick="handleLogout()" class="w-full flex items-center space-x-3 px-4 py-3 text-red-500 hover:bg-red-50 rounded-lg"><span>ğŸšª Sair</span></button>
            </div>
        </aside>

        <main class="flex-grow p-10 ml-64">
            <header class="mb-8 flex justify-between items-center">
                <h1 class="text-4xl font-bold text-gray-900">Rastreamento</h1>
                <select id="petSelector" class="px-4 py-2 border rounded-lg bg-white"><option>Carregando...</option></select>
            </header>
            
            <div id="alertContainer" class="fixed top-5 right-5 z-50 flex flex-col gap-2"></div>

            <div class="flex gap-8 h-[600px]">
                <div class="w-3/4 relative">
                    <div id="map" class="h-full w-full rounded-lg shadow-md"></div>
                    
                    <!-- Controles da Cerca -->
                    <div class="absolute top-4 right-4 z-[1000] bg-white p-2 rounded shadow flex flex-col gap-2">
                        <button onclick="toggleGeofenceMode()" id="btnGeofenceMode" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600 shadow transition">
                            ğŸ›¡ï¸ Criar Cerca
                        </button>
                        <button onclick="clearAllGeofences()" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600 shadow transition">
                            ğŸ—‘ï¸ Apagar Cercas
                        </button>
                    </div>
                </div>

                <div class="w-1/4 flex flex-col gap-4">
                    <div class="bg-white rounded-xl shadow-md p-6">
                        <h2 id="petName" class="text-xl font-bold mb-2">Selecione</h2>
                        <div class="text-sm space-y-2">
                            <p>Status: <span id="petStatus" class="font-bold">-</span></p>
                            <p>Bateria: <span id="batteryLevel" class="font-bold">-</span></p>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-md p-4 flex-grow overflow-y-auto">
                        <h3 class="font-bold text-gray-700 mb-3">ğŸ”” Alertas Recentes</h3>
                        <div id="alertsList" class="text-sm space-y-2 text-gray-600">
                            <p>Nenhum alerta.</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="{{ url_for('static', filename='api.js') }}"></script>
    <script src="{{ url_for('static', filename='map.js') }}"></script>

    <script>
        let currentPetId = null;
        let isGeofenceMode = false;

        document.addEventListener('DOMContentLoaded', async () => {
            if (typeof window.initMap === 'function') {
                window.initMap('map');
            }

            const response = await getPets();
            const selector = document.getElementById('petSelector');
            selector.innerHTML = '';
            response.pets.forEach(p => {
                selector.innerHTML += `<option value="${p.id}">${p.name}</option>`;
            });
            
            if(response.pets.length > 0) {
                selector.dispatchEvent(new Event('change'));
            }

            loadAlerts();
            setupMapClickListener();
        });

        function setupMapClickListener() {
            const checkMapInterval = setInterval(() => {
                if (window.map) {
                    clearInterval(checkMapInterval);
                    window.map.on('click', async (e) => {
                        if (!isGeofenceMode) return;
                        if (!currentPetId) return alert("Selecione um pet primeiro!");

                        if (confirm("Criar cerca virtual aqui (Raio 100m)?")) {
                            try {
                                await createGeofence(currentPetId, "Zona Segura", e.latlng.lat, e.latlng.lng, 100);
                                toggleGeofenceMode();
                                loadGeofences(currentPetId);
                                showAlert("Cerca criada!", "success");
                            } catch (err) {
                                console.error(err);
                                alert("Erro ao criar cerca.");
                            }
                        }
                    });
                }
            }, 500);
        }

        function toggleGeofenceMode() {
            isGeofenceMode = !isGeofenceMode;
            const btn = document.getElementById('btnGeofenceMode');
            const mapDiv = document.getElementById('map');

            if(isGeofenceMode) {
                btn.innerText = "âŒ Cancelar";
                btn.classList.replace('bg-blue-500', 'bg-gray-500');
                mapDiv.style.cursor = "crosshair";
                showAlert("Clique no mapa para definir o centro", "info");
            } else {
                btn.innerText = "ğŸ›¡ï¸ Criar Cerca";
                btn.classList.replace('bg-gray-500', 'bg-blue-500');
                mapDiv.style.cursor = "";
            }
        }

document.getElementById('petSelector').addEventListener('change', async (e) => {
    const petId = e.target.value;
    
    // 1. Se nÃ£o tiver ID (opÃ§Ã£o padrÃ£o), para tudo
    if (!petId) return;

    currentPetId = petId;

    // 2. Limpa o mapa antigo
    if (typeof window.clearMap === 'function') window.clearMap();

    try {
        // 3. Carrega o pet no mapa (Isso que coloca a FOTO no marcador)
        // A funÃ§Ã£o retorna os dados do pet (incluindo nome, bateria, foto)
        const pet = await window.loadPetOnMap(currentPetId);

        // 4. Atualiza a barra lateral com os dados retornados
        updateInfo(pet);
        
        // 5. Carrega as cercas
        loadGeofences(currentPetId);

        // 6. Inicia o rastreamento em tempo real
        startStream(currentPetId);
        
    } catch (error) {
        console.error("Erro ao carregar pet:", error);
    }
});

        async function loadGeofences(id) {
            try {
                const res = await getGeofences(id);
                if(window.showAllGeofences) window.showAllGeofences(res.zones);
            } catch (e) { console.error("Erro ao carregar cercas", e); }
        }

        // --- FUNÃ‡ÃƒO DE DELETAR CORRIGIDA ---
        async function clearAllGeofences() {
            if(!currentPetId) return alert("Selecione um pet");
            if(!confirm("Tem certeza que deseja apagar TODAS as cercas deste pet?")) return;
            
            try {
                // 1. Pega a lista atualizada do servidor
                const res = await getGeofences(currentPetId);
                
                if (res.zones.length === 0) {
                    showAlert("NÃ£o hÃ¡ cercas para apagar.", "info");
                    return;
                }

                let deletedCount = 0;

                // 2. Deleta uma por uma
                for(let zone of res.zones) {
                    try {
                        await deleteGeofence(zone.id);
                        deletedCount++;
                    } catch (err) {
                        console.error(`Erro ao deletar zona ${zone.id}`, err);
                    }
                }

                // 3. Limpa visualmente e recarrega para confirmar
                if (typeof window.clearGeofences === 'function') window.clearGeofences();
                await loadGeofences(currentPetId); // Recarrega do servidor para ter certeza

                if (deletedCount > 0) {
                    showAlert(`${deletedCount} cercas removidas.`, "success");
                } else {
                    showAlert("Erro ao remover cercas.", "error");
                }

            } catch (error) {
                console.error("Erro geral ao deletar cercas:", error);
                showAlert("Erro de conexÃ£o ao apagar cercas.", "error");
            }
        }

function startStream(id) {
    const evt = new EventSource(`/api/pets/${id}/stream`);
    evt.onmessage = (e) => {
        const data = JSON.parse(e.data);
        
        if(window.updatePetMarker) {
            // Pegamos os dados atuais da tela para reaproveitar nome e foto
            const petName = document.getElementById('petName').innerText;
            window.updatePetMarker(data.latitude, data.longitude, petName, 'online', window.currentPetPhotoUrl);
        }
        
        if(data.alert) showAlert(data.alert);
    };
}

        function updateInfo(pet) {
            document.getElementById('petName').innerText = pet.name;
            document.getElementById('petStatus').innerText = pet.is_online ? 'ONLINE' : 'OFFLINE';
            document.getElementById('batteryLevel').innerText = pet.battery_level + '%';
        }

        async function loadAlerts() {
            const res = await getAlerts();
            const list = document.getElementById('alertsList');
            if(res.alerts.length > 0) {
                list.innerHTML = res.alerts.map(a => 
                    `<div class="p-2 bg-red-50 border-l-4 border-red-500 text-xs mb-2">
                        <b>${new Date(a.created_at).toLocaleTimeString()}</b><br>${a.message}
                    </div>`
                ).join('');
            } else {
                list.innerHTML = '<p>Nenhum alerta recente.</p>';
            }
        }

        function showAlert(msg, type="error") {
            const div = document.createElement('div');
            div.className = `alert-toast bg-white border-l-4 ${type==='success'?'border-green-500':(type==='info'?'border-blue-500':'border-red-500')} p-4 shadow-lg rounded flex items-center justify-between min-w-[300px]`;
            div.innerHTML = `<div><h3 class="font-bold text-gray-700">${type==='success'?'Sucesso':(type==='info'?'Info':'Alerta!')}</h3><p class="text-sm">${msg}</p></div>`;
            document.getElementById('alertContainer').appendChild(div);
            setTimeout(() => div.remove(), 5000);
            if(type === 'error' || msg.includes('saiu')) loadAlerts();
        }

        async function handleLogout() {
            if(confirm('Sair?')) { await logout(); window.location.href='/login'; }
        }
    </script>
</body>
</html>